{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>{%block title%} {%endblock%}</title>
  <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="{% static 'img/kaiadmin/favicon.ico' %}" type="image/x-icon" />

  <style>
    /* Desktop only hover sidebar (min-width: 992px for better desktop targeting) */
    @media (min-width: 992px) {

      /* Force sidebar to be collapsed by default */
      .wrapper .sidebar {
        width: 60px !important;
        transition: width 0.3s ease !important;
        overflow: hidden !important;
      }

      /* Expand on hover */
      .wrapper .sidebar:hover {
        width: 250px !important;
        overflow: visible !important;
      }

      /* Hide text elements when collapsed */
      .wrapper .sidebar:not(:hover) .nav-secondary li a p,
      .wrapper .sidebar:not(:hover) .nav-secondary li a span.sub-item,
      .wrapper .sidebar:not(:hover) .sidebar-content .nav-section h4,
      .wrapper .sidebar:not(:hover) .sidebar-content .nav-section .sidebar-mini-icon {
        opacity: 0 !important;
        visibility: hidden !important;
        transition: all 0.3s ease !important;
      }

      /* Show text elements when expanded */
      .wrapper .sidebar:hover .nav-secondary li a p,
      .wrapper .sidebar:hover .nav-secondary li a span.sub-item,
      .wrapper .sidebar:hover .sidebar-content .nav-section h4,
      .wrapper .sidebar:hover .sidebar-content .nav-section .sidebar-mini-icon {
        opacity: 1 !important;
        visibility: visible !important;
        transition: all 0.3s ease 0.1s !important;
      }


      /* Ensure icons are properly sized and centered */
      .wrapper .sidebar:not(:hover) .nav-secondary li a i {
        font-size: 18px !important;
        width: auto !important;
        text-align: center !important;
        margin: 0 !important;
        display: block !important;
      }

      /* Make sure main icons stay visible */
      .wrapper .sidebar:not(:hover) .nav-secondary li a>i {
        opacity: 1 !important;
        visibility: visible !important;
      }

      /* Hide dropdown carets when collapsed */
      .wrapper .sidebar:not(:hover) .caret {
        display: none !important;
      }

      /* Hide all collapsed submenus when sidebar is collapsed */
      .wrapper .sidebar:not(:hover) .collapse {
        display: none !important;
      }

      /* Adjust main panel - collapsed state */
      .wrapper .main-panel {
        margin-left: 80px !important;
        width: calc(100% - 60px) !important;
        transition: all 0.3s ease !important;
      }

      /* Adjust main panel - expanded state */
      .wrapper .sidebar:hover~.main-panel {
        margin-left: 250px !important;
        width: calc(100% - 250px) !important;
      }

      /* Logo size adjustment when collapsed */
      .wrapper .sidebar:not(:hover) .sidebar-logo img {
        width: 35px !important;
        height: auto !important;
      }

      /* Hide toggle buttons when collapsed */
      .wrapper .sidebar:not(:hover) .nav-toggle {
        opacity: 0 !important;
        visibility: hidden !important;
      }

      /* Ensure proper z-index for expanded sidebar */
      .wrapper .sidebar:hover {
        z-index: 1000 !important;
      }
    }
  </style>
  <!-- Fonts and icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    integrity="sha512-dymN7x4vS+U/n2Pb5L3PvGj3g3xFhPtX2+oCFYoMumOqUg6G4z5fdbUu9Qafj0pychj1zLkUp1tb6dXHjdXpwA=="
    crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css">

  <script src="{% static 'js/plugin/webfont/webfont.min.js' %}"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: [
          "Font Awesome 5 Solid",
          "Font Awesome 5 Regular",
          "Font Awesome 5 Brands",
          "simple-line-icons",
        ],
        urls: ["{% static 'css/fonts.min.css' %}"],
      },
      active: function () {
        sessionStorage.fonts = true;
      },
    });
  </script>

  <!-- CSS Files -->
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" />
  <link rel="stylesheet" href="{% static 'css/plugins.min.css' %}" />
  <link rel="stylesheet" href="{% static 'css/kaiadmin.min.css' %}" />

  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link rel="stylesheet" href="{% static 'css/demo.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

</head>

<body>

  <div class="wrapper">
    <!-- Sidebar -->
    <div class="sidebar" data-background-color="dark">
      <div class="sidebar-logo">
      </div>
      <div class="sidebar-wrapper scrollbar scrollbar-inner">
        <div class="sidebar-content">
          <ul class="nav nav-secondary">
            <li class="nav-item active">
              <a href="{%url 'adminapp:admin_dashboard'%}" class="collapsed" aria-expanded="false">
                <i class="fas fa-home"></i>
                <p>Admin Panel</p>
              </a>
            </li>

            <li class="nav-section">
              <span class="sidebar-mini-icon">
                <i class="fa fa-ellipsis-h"></i>
              </span>
              <h4 class="text-section">MANAGEMENT</h4>
            </li>

            <!-- Locations -->
            <!-- Locations -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#locations">
                <i class="fa-solid fa-user"></i>
                <p>User Management</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="locations">
                <ul class="nav nav-collapse">
                  <!-- Processing Centers with sub-menu -->
                  <li>
                    <a data-bs-toggle="collapse" href="#processing-centers">
                      <span class="sub-item">
                        <i class="fa-solid fa-user"></i>
                        Users
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="processing-centers">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:users_list' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:create_user' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Add
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>
                </ul>
              </div>
            </li>

            <!-- Personnel -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#purchase">
                <i class="fas fa-shopping-cart"></i>
                <p>Purchase Management</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="purchase">
                <ul class="nav nav-collapse">

                  <!-- Spot Purchase -->
                  <li>
                    <a data-bs-toggle="collapse" href="#spot-purchase">
                      <span class="sub-item">
                        <i class="fas fa-bolt"></i>
                        Spot Purchase
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="spot-purchase">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:spot_purchase_list' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:spot_purchase_add' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>

                  <!-- Local Purchase -->
                  <li>
                    <a data-bs-toggle="collapse" href="#local-purchase">
                      <span class="sub-item">
                        <i class="fas fa-map-marker-alt"></i>
                        Local Purchase
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="local-purchase">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:local_purchase_list' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:local_purchase_create' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>

                  <!-- Spot Purchase Workout -->
                  <li>
                    <a data-bs-toggle="collapse" href="#spot-purchase-workout">
                      <span class="sub-item">
                        <i class="fas fa-dumbbell"></i>
                        Spot Workout
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="spot-purchase-workout">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:spot_purchase_workout_summary' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:spot_purchase_workout_summary' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>

                  <!-- Local Purchase Workout -->
                  <li>
                    <a data-bs-toggle="collapse" href="#local-purchase-workout">
                      <span class="sub-item">
                        <i class="fas fa-running"></i>
                        Local Workout
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="local-purchase-workout">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:local_purchase_workout_summary' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:local_purchase_workout_summary' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>

                </ul>
              </div>
            </li>


            <!-- Products -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#products">
                <i class="fa-solid fa-gear"></i>
                <p>Processing Operations</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="products">
                <ul class="nav nav-collapse">

                  <!-- Peeling Types with sub-menu -->
                  <li>
                    <a data-bs-toggle="collapse" href="#peeling-types">
                      <span class="sub-item">
                        <i class="fas fa-layer-group"></i>
                        Peeling Shed
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="peeling-types">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:peeling_shed_supply_list' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:create_peeling_shed_supply' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>
                </ul>
              </div>
            </li>

            <!-- Financial -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#financial">
                <i class="fa-solid fa-snowflake"></i>
                <p>Freezing Operations</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="financial">
                <ul class="nav nav-collapse">
                  <!-- Tenants with sub-menu -->
                  <li>
                    <a data-bs-toggle="collapse" href="#tenants">
                      <span class="sub-item">
                        <i class="fa-solid fa-shop"></i>
                        Spot Freezing Entry
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="tenants">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:freezing_entry_spot_list' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:freezing_entry_spot_create' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>

                  <!-- Purchase Overheads with sub-menu -->
                  <li>
                    <a data-bs-toggle="collapse" href="#purchase-overheads">
                      <span class="sub-item">
                        <i class="fas fa-shopping-cart"></i>
                        Local Freezing <br>Entry
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="purchase-overheads">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:freezing_entry_local_list' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:freezing_entry_local_create' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>

                  <li>
                    <a data-bs-toggle="collapse" href="#tenant-freezing">
                      <span class="sub-item">
                        <i class="fa-solid fa-snowflake"></i>
                        Tenant Freezing <br>Entry
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="tenant-freezing">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:list_freezing_entry_tenant' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:create_freezing_entry_tenant' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>

                  <li>
                    <a data-bs-toggle="collapse" href="#return-tenant">
                      <span class="sub-item">
                        <i class="fa-solid fa-snowflake"></i>
                        Return Tenant Freezing Entry
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="return-tenant">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:list_return_tenant' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:create_return_tenant' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>

                  <!-- Peeling Overheads with sub-menu -->
                  <li>
                    <a data-bs-toggle="collapse" href="#peeling-overheads">
                      <span class="sub-item">
                        <i class="fas fa-warehouse"></i>
                        Freezing Workout
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="peeling-overheads">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:freezing_workout' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:freezing_workout' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>

                </ul>
              </div>
            </li>

            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#shipping">
                <i class="fa-solid fa-truck-fast"></i>
                <p>Shipping Operations</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="shipping">
                <ul class="nav nav-collapse">
                  <!-- Tenants with sub-menu -->
                  <li>
                    <a data-bs-toggle="collapse" href="#tenants">
                      <span class="sub-item">
                        <i class="fa-solid fa-shop"></i>
                        Pre Shipment <br>Workout
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="tenants">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:preshipment_workout_list' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:create_preshipment_workout' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>


                </ul>
              </div>
            </li>

            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#bill">
                <i class="fa-solid fa-file"></i>
                <p>Billing Operations</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="bill">
                <ul class="nav nav-collapse">
                  <!-- Tenants with sub-menu -->
                  <li>
                    <a data-bs-toggle="collapse" href="#tenants">
                      <span class="sub-item">
                        <i class="fa-solid fa-shop"></i>
                        Tenant Bill
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="tenants">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:bill_list' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:generate_manual_bill' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>
                  <li>
                    <a data-bs-toggle="collapse" href="#main">
                      <span class="sub-item">
                        <i class="fa-solid fa-file-import"></i>
                        Main Stock Bill
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="main">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="{% url 'adminapp:bill_list' %}">
                            <span class="sub-item">
                              <i class="fas fa-list"></i>
                              List
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="{% url 'adminapp:generate_manual_bill' %}">
                            <span class="sub-item">
                              <i class="fas fa-plus"></i>
                              Create
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>


                </ul>
              </div>
            </li>

            <!-- Masters Dashboard -->
            <li class="nav-item">
              <a href="{% url 'adminapp:master' %}">
                <i class="fas fa-tachometer-alt"></i>
                <p>Master Dashboard
                </p>
              </a>
            </li>

            <li class="nav-section">
              <span class="sidebar-mini-icon">
                <i class="fa fa-ellipsis-h"></i>
              </span>
              <h4 class="text-section">System</h4>
            </li>



            <!-- Profile & Settings -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#profile">
                <i class="fas fa-user-circle"></i>
                <p>Profile & Settings</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="profile">
                <ul class="nav nav-collapse">
                  <li>
                    <a href="#">
                      <span class="sub-item">
                        <i class="fas fa-user-edit"></i>
                        Profile Settings
                      </span>
                    </a>
                  </li>
                  <li>
                    <a href="#">
                      <span class="sub-item">
                        <i class="fas fa-cog"></i>
                        System Settings
                      </span>
                    </a>
                  </li>
                  <li>
                    <a href="#">
                      <span class="sub-item">
                        <i class="fas fa-database"></i>
                        Backup & Restore
                      </span>
                    </a>
                  </li>
                </ul>
              </div>
            </li>

            <!-- Profile & Settings -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#report">
                <i class="fas fa-chart-line"></i> <!-- General reports icon -->
                <p>Reports</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="report">
                <ul class="nav nav-collapse">
                  <li>
                    <a href="#">
                      <span class="sub-item">
                        <i class="fas fa-shopping-cart"></i>
                        Spot Purchase Report
                      </span>
                    </a>
                  </li>
                  <li>
                    <a href="#">
                      <span class="sub-item">
                        <i class="fa-solid fa-house-chimney"></i>
                        Local Purchase Report
                      </span>
                    </a>
                  </li>
                  <li>
                    <a href="#">
                      <span class="sub-item">
                        <i class="fas fa-receipt"></i>
                        Peeling Shed Report
                      </span>
                    </a>
                  </li>
                  <li>
                    <a href="#">
                      <span class="sub-item">
                        <i class="fa-solid fa-snowflake"></i>
                        Freezing Report
                      </span>
                    </a>
                  </li>
                  <!-- Peeling Types with sub-menu -->
                  <li>
                    <a data-bs-toggle="collapse" href="#peeling-types">
                      <span class="sub-item">
                        <i class="fas fa-layer-group"></i>
                        Tenant Freezing Report
                        <span class="caret"></span>
                      </span>
                    </a>
                    <div class="collapse" id="peeling-types">
                      <ul class="nav nav-collapse subnav">
                        <li>
                          <a href="">
                            <span class="sub-item">
                              <i class="fa-solid fa-file"></i>
                              Get Summary
                            </span>
                          </a>
                        </li>
                        <li>
                          <a href="">
                            <span class="sub-item">
                              <i class="fa-solid fa-file"></i>
                              Get Balance
                            </span>
                          </a>
                        </li>
                      </ul>
                    </div>
                  </li>
                </ul>
              </div>
            </li>


            <!-- Logout -->
            <li class="nav-item">
              <a href="{% url 'adminapp:admin_logout' %}">
                <i class="fas fa-sign-out-alt"></i>
                <p>Logout</p>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!-- End Sidebar -->

    <style>
      /* Hide the .main-header on desktop (>=992px width) */
@media screen and (min-width: 992px) {
  .main-header {
    display: none !important;
  }
}

    </style>

    <div class="main-panel">
      <div class="main-header">
        <div class="main-header-logo">
          <!-- Logo Header -->
          <div class="logo-header" data-background-color="dark">
            <a href="index.html" class="logo">
              <img src="{% static 'img/kaiadmin/logo_light.svg' %}" alt="navbar brand" class="navbar-brand"
                height="20" />
            </a>
            <div class="nav-toggle">
              <button class="btn btn-toggle toggle-sidebar">
                <i class="gg-menu-right"></i>
              </button>
              <button class="btn btn-toggle sidenav-toggler">
                <i class="gg-menu-left"></i>
              </button>
            </div>
            <button class="topbar-toggler more">
              <i class="gg-more-vertical-alt"></i>
            </button>
          </div>
          <!-- End Logo Header -->
        </div>
        <!-- Navbar Header -->
        <nav class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom">
          <div class="container-fluid">

            <ul class="navbar-nav topbar-nav ms-md-auto align-items-center">
              <li class="nav-item topbar-icon dropdown hidden-caret d-flex d-lg-none">
                <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button"
                  aria-expanded="false" aria-haspopup="true">
                  <i class="fa fa-search"></i>
                </a>
                <ul class="dropdown-menu dropdown-search animated fadeIn">
                  <form class="navbar-left navbar-form nav-search">
                    <div class="input-group">
                      <input type="text" placeholder="Search ..." class="form-control" />
                    </div>
                  </form>
                </ul>
              </li>
              <li class="nav-item topbar-icon dropdown hidden-caret">
                <a class="nav-link dropdown-toggle" href="#" id="messageDropdown" role="button"
                  data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fa fa-envelope"></i>
                </a>
                <ul class="dropdown-menu messages-notif-box animated fadeIn" aria-labelledby="messageDropdown">
                  <li>
                    <div class="dropdown-title d-flex justify-content-between align-items-center">
                      Messages
                      <a href="#" class="small">Mark all as read</a>
                    </div>
                  </li>
                  <li>
                    <div class="message-notif-scroll scrollbar-outer">
                      <div class="notif-center">
                        <a href="#">
                          <div class="notif-img">
                            <img src="{% static 'img/jm_denis.jpg' %}" alt="Img Profile" />
                          </div>
                          <div class="notif-content">
                            <span class="subject">Jimmy Denis</span>
                            <span class="block"> How are you ? </span>
                            <span class="time">5 minutes ago</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-img">
                            <img src="{% static 'img/chadengle.jpg' %}" alt="Img Profile" />
                          </div>
                          <div class="notif-content">
                            <span class="subject">Chad</span>
                            <span class="block"> Ok, Thanks ! </span>
                            <span class="time">12 minutes ago</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-img">
                            <img src="{% static 'img/mlane.jpg' %}" alt="Img Profile" />
                          </div>
                          <div class="notif-content">
                            <span class="subject">Jhon Doe</span>
                            <span class="block">
                              Ready for the meeting today...
                            </span>
                            <span class="time">12 minutes ago</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-img">
                            <img src="{% static 'img/talha.jpg' %}" alt="Img Profile" />
                          </div>
                          <div class="notif-content">
                            <span class="subject">Talha</span>
                            <span class="block"> Hi, Apa Kabar ? </span>
                            <span class="time">17 minutes ago</span>
                          </div>
                        </a>
                      </div>
                    </div>
                  </li>
                  <li>
                    <a class="see-all" href="javascript:void(0);">See all messages<i class="fa fa-angle-right"></i>
                    </a>
                  </li>
                </ul>
              </li>
              <li class="nav-item topbar-icon dropdown hidden-caret">
                <a class="nav-link dropdown-toggle" href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown"
                  aria-haspopup="true" aria-expanded="false">
                  <i class="fa fa-bell"></i>
                  <span class="notification">4</span>
                </a>
                <ul class="dropdown-menu notif-box animated fadeIn" aria-labelledby="notifDropdown">
                  <li>
                    <div class="dropdown-title">
                      You have 4 new notification
                    </div>
                  </li>
                  <li>
                    <div class="notif-scroll scrollbar-outer">
                      <div class="notif-center">
                        <a href="#">
                          <div class="notif-icon notif-primary">
                            <i class="fa fa-user-plus"></i>
                          </div>
                          <div class="notif-content">
                            <span class="block"> New user registered </span>
                            <span class="time">5 minutes ago</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-icon notif-success">
                            <i class="fa fa-comment"></i>
                          </div>
                          <div class="notif-content">
                            <span class="block">
                              Rahmad commented on Admin
                            </span>
                            <span class="time">12 minutes ago</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-img">
                            <img src="{% static 'img/profile2.jpg' %}" alt="Img Profile" />
                          </div>
                          <div class="notif-content">
                            <span class="block">
                              Reza send messages to you
                            </span>
                            <span class="time">12 minutes ago</span>
                          </div>
                        </a>
                        <a href="#">
                          <div class="notif-icon notif-danger">
                            <i class="fa fa-heart"></i>
                          </div>
                          <div class="notif-content">
                            <span class="block"> Farrah liked Admin </span>
                            <span class="time">17 minutes ago</span>
                          </div>
                        </a>
                      </div>
                    </div>
                  </li>
                  <li>
                    <a class="see-all" href="javascript:void(0);">See all notifications<i class="fa fa-angle-right"></i>
                    </a>
                  </li>
                </ul>
              </li>
              <li class="nav-item topbar-icon dropdown hidden-caret">
                <a class="nav-link" data-bs-toggle="dropdown" href="#" aria-expanded="false">
                  <i class="fas fa-layer-group"></i>
                </a>
                <div class="dropdown-menu quick-actions animated fadeIn">
                  <div class="quick-actions-header">
                    <span class="title mb-1">Quick Actions</span>
                    <span class="subtitle op-7">Shortcuts</span>
                  </div>
                  <div class="quick-actions-scroll scrollbar-outer">
                    <div class="quick-actions-items">
                      <div class="row m-0">
                        <a class="col-6 col-md-4 p-0" href="#">
                          <div class="quick-actions-item">
                            <div class="avatar-item bg-danger rounded-circle">
                              <i class="far fa-calendar-alt"></i>
                            </div>
                            <span class="text">Calendar</span>
                          </div>
                        </a>
                        <a class="col-6 col-md-4 p-0" href="#">
                          <div class="quick-actions-item">
                            <div class="avatar-item bg-warning rounded-circle">
                              <i class="fas fa-map"></i>
                            </div>
                            <span class="text">Maps</span>
                          </div>
                        </a>
                        <a class="col-6 col-md-4 p-0" href="#">
                          <div class="quick-actions-item">
                            <div class="avatar-item bg-info rounded-circle">
                              <i class="fas fa-file-excel"></i>
                            </div>
                            <span class="text">Reports</span>
                          </div>
                        </a>
                        <a class="col-6 col-md-4 p-0" href="#">
                          <div class="quick-actions-item">
                            <div class="avatar-item bg-success rounded-circle">
                              <i class="fas fa-envelope"></i>
                            </div>
                            <span class="text">Emails</span>
                          </div>
                        </a>
                        <a class="col-6 col-md-4 p-0" href="#">
                          <div class="quick-actions-item">
                            <div class="avatar-item bg-primary rounded-circle">
                              <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <span class="text">Invoice</span>
                          </div>
                        </a>
                        <a class="col-6 col-md-4 p-0" href="#">
                          <div class="quick-actions-item">
                            <div class="avatar-item bg-secondary rounded-circle">
                              <i class="fas fa-credit-card"></i>
                            </div>
                            <span class="text">Payments</span>
                          </div>
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </li>

              <li class="nav-item topbar-user dropdown hidden-caret">
                <a class="dropdown-toggle profile-pic" data-bs-toggle="dropdown" href="#" aria-expanded="false">
                  <div class="avatar-sm">
                    <img src="{% static 'img/profile.jpg' %}" alt="..." class="avatar-img rounded-circle" />
                  </div>
                  <span class="profile-username">
                    <span class="op-7">Hi,</span>
                    <span class="fw-bold">Admin</span>
                  </span>
                </a>
                <ul class="dropdown-menu dropdown-user animated fadeIn">
                  <div class="dropdown-user-scroll scrollbar-outer">
                    <li>
                      <div class="user-box">
                        <div class="avatar-lg">
                          <img src="{% static 'img/profile.jpg' %}" alt="image profile" class="avatar-img rounded" />
                        </div>
                        <div class="u-text">
                          <h4>Hizrian</h4>
                          <p class="text-muted">hello@example.com</p>
                          <a href="profile.html" class="btn btn-xs btn-secondary btn-sm">View Profile</a>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="dropdown-divider"></div>
                      <a class="dropdown-item" href="#">My Profile</a>
                      <a class="dropdown-item" href="#">My Balance</a>
                      <a class="dropdown-item" href="#">Inbox</a>
                      <div class="dropdown-divider"></div>
                      <a class="dropdown-item" href="#">Account Setting</a>
                      <div class="dropdown-divider"></div>
                      <a class="dropdown-item" href="#">Logout</a>
                    </li>
                  </div>
                </ul>
              </li>
            </ul>
          </div>
        </nav>
        <!-- End Navbar -->
      </div>

      {%block content%}

      {%endblock%}

      <footer class="footer">
        <div class="container-fluid d-flex justify-content-center">
          <div class="copyright">
            2025, Made by
            <a href="">Hostlane Technolab</a>
          </div>

        </div>
      </footer>
    </div>

    <!-- Custom template | don't include it in your project! -->
    <div class="custom-template">
      <div class="title">Settings</div>
      <div class="custom-content">
        <div class="switcher">
          <div class="switch-block">
            <h4>Logo Header</h4>
            <div class="btnSwitch">
              <button type="button" class="selected changeLogoHeaderColor" data-color="dark"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="blue"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="purple"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="light-blue"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="green"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="orange"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="red"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="white"></button>
              <br />
              <button type="button" class="changeLogoHeaderColor" data-color="dark2"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="blue2"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="purple2"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="light-blue2"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="green2"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="orange2"></button>
              <button type="button" class="changeLogoHeaderColor" data-color="red2"></button>
            </div>
          </div>
          <div class="switch-block">
            <h4>Navbar Header</h4>
            <div class="btnSwitch">
              <button type="button" class="changeTopBarColor" data-color="dark"></button>
              <button type="button" class="changeTopBarColor" data-color="blue"></button>
              <button type="button" class="changeTopBarColor" data-color="purple"></button>
              <button type="button" class="changeTopBarColor" data-color="light-blue"></button>
              <button type="button" class="changeTopBarColor" data-color="green"></button>
              <button type="button" class="changeTopBarColor" data-color="orange"></button>
              <button type="button" class="changeTopBarColor" data-color="red"></button>
              <button type="button" class="selected changeTopBarColor" data-color="white"></button>
              <br />
              <button type="button" class="changeTopBarColor" data-color="dark2"></button>
              <button type="button" class="changeTopBarColor" data-color="blue2"></button>
              <button type="button" class="changeTopBarColor" data-color="purple2"></button>
              <button type="button" class="changeTopBarColor" data-color="light-blue2"></button>
              <button type="button" class="changeTopBarColor" data-color="green2"></button>
              <button type="button" class="changeTopBarColor" data-color="orange2"></button>
              <button type="button" class="changeTopBarColor" data-color="red2"></button>
            </div>
          </div>
          <div class="switch-block">
            <h4>Sidebar</h4>
            <div class="btnSwitch">
              <button type="button" class="changeSideBarColor" data-color="white"></button>
              <button type="button" class="selected changeSideBarColor" data-color="dark"></button>
              <button type="button" class="changeSideBarColor" data-color="dark2"></button>
            </div>
          </div>
        </div>
      </div>
      <div class="custom-toggle">
        <i class="icon-settings"></i>
      </div>
    </div>
    <!-- End Custom template -->
  </div>
  <!--   Core JS Files   -->
  <script src="{% static 'js/core/jquery-3.7.1.min.js' %}"></script>
  <script src="{% static 'js/core/popper.min.js' %}"></script>
  <script src="{% static 'js/core/bootstrap.min.js' %}"></script>

  <!-- jQuery Scrollbar -->
  <script src="{% static 'js/plugin/jquery-scrollbar/jquery.scrollbar.min.js' %}"></script>

  <!-- Chart JS -->
  <script src="{% static 'js/plugin/chart.js/chart.min.js' %}"></script>

  <!-- jQuery Sparkline -->
  <script src="{% static 'js/plugin/jquery.sparkline/jquery.sparkline.min.js' %}"></script>

  <!-- Chart Circle -->
  <script src="{% static 'js/plugin/chart-circle/circles.min.js' %}"></script>

  <!-- Datatables -->
  <script src="{% static 'js/plugin/datatables/datatables.min.js' %}"></script>

  <!-- Bootstrap Notify -->
  <!-- <script src="{% static 'js/plugin/bootstrap-notify/bootstrap-notify.min.js' %}"></script> -->

  <!-- jQuery Vector Maps -->
  <script src="{% static 'js/plugin/jsvectormap/jsvectormap.min.js' %}"></script>
  <script src="{% static 'js/plugin/jsvectormap/world.js' %}"></script>

  <!-- Sweet Alert -->
  <script src="{% static 'js/plugin/sweetalert/sweetalert.min.js' %}"></script>

  <!-- Kaiadmin JS -->
  <script src="{% static 'js/kaiadmin.min.js' %}"></script>

  <!-- Kaiadmin DEMO methods, don't include it in your project! -->
  <script src="{% static 'js/setting-demo.js' %}"></script>
  <script src="{% static 'js/demo.js' %}"></script>
  <script>
    $("#lineChart").sparkline([102, 109, 120, 99, 110, 105, 115], {
      type: "line",
      height: "70",
      width: "100%",
      lineWidth: "2",
      lineColor: "#177dff",
      fillColor: "rgba(23, 125, 255, 0.14)",
    });

    $("#lineChart2").sparkline([99, 125, 122, 105, 110, 124, 115], {
      type: "line",
      height: "70",
      width: "100%",
      lineWidth: "2",
      lineColor: "#f3545d",
      fillColor: "rgba(243, 84, 93, .14)",
    });

    $("#lineChart3").sparkline([105, 103, 123, 100, 95, 105, 115], {
      type: "line",
      height: "70",
      width: "100%",
      lineWidth: "2",
      lineColor: "#ffa534",
      fillColor: "rgba(255, 165, 52, .14)",
    });
  </script>
  <script>
    $(document).ready(function () {
      $("#basic-datatables").DataTable({});

      $("#multi-filter-select").DataTable({
        pageLength: 5,
        initComplete: function () {
          this.api()
            .columns()
            .every(function () {
              var column = this;
              var select = $(
                '<select class="form-select"><option value=""></option></select>'
              )
                .appendTo($(column.footer()).empty())
                .on("change", function () {
                  var val = $.fn.dataTable.util.escapeRegex($(this).val());

                  column
                    .search(val ? "^" + val + "$" : "", true, false)
                    .draw();
                });

              column
                .data()
                .unique()
                .sort()
                .each(function (d, j) {
                  select.append(
                    '<option value="' + d + '">' + d + "</option>"
                  );
                });
            });
        },
      });

      // Add Row
      $("#add-row").DataTable({
        pageLength: 5,
      });

      var action =
        '<td> <div class="form-button-action"> <button type="button" data-bs-toggle="tooltip" title="" class="btn btn-link btn-primary btn-lg" data-original-title="Edit Task"> <i class="fa fa-edit"></i> </button> <button type="button" data-bs-toggle="tooltip" title="" class="btn btn-link btn-danger" data-original-title="Remove"> <i class="fa fa-times"></i> </button> </div> </td>';

      $("#addRowButton").click(function () {
        $("#add-row")
          .dataTable()
          .fnAddData([
            $("#addName").val(),
            $("#addPosition").val(),
            $("#addOffice").val(),
            action,
          ]);
        $("#addRowModal").modal("hide");
      });
    });
  </script>




  <script>
    // Sidebar hover functionality for desktop only
    $(document).ready(function () {
      // Only apply on desktop screens
      if ($(window).width() >= 992) {
        $('.sidebar').hover(
          function () {
            // Mouse enter - expand
            $(this).addClass('sidebar-expanded');
            $('.main-panel').css({
              'margin-left': '250px',
              'width': 'calc(100% - 250px)'
            });
          },
          function () {
            // Mouse leave - collapse
            $(this).removeClass('sidebar-expanded');
            $('.main-panel').css({
              'margin-left': '60px',
              'width': 'calc(100% - 60px)'
            });
          }
        );
      }

      // Re-check on window resize
      $(window).resize(function () {
        if ($(window).width() < 992) {
          // Reset to original styles on mobile
          $('.main-panel').css({
            'margin-left': '',
            'width': ''
          });
        }
      });
    });
  </script>





    <!-- Clone & Add More Formset -->
    <script>
        $(document).ready(function () {
            const formsetContainer = $('#formset-container');
            const totalForms = $('#id_form-TOTAL_FORMS');

            // Add CSS classes to existing forms
            function addCalculationClasses($form) {
                $form.find('[name*="item"]').addClass('item-select');
                $form.find('[name*="species"]').addClass('species-select');
                $form.find('[name*="peeling_type"]').addClass('peeling-select');
                $form.find('[name*="grade"]').addClass('grade-select');
                $form.find('[name*="slab_quantity"]').addClass('slab-quantity');
                $form.find('[name*="c_s_quantity"]').addClass('cs-quantity');
                $form.find('[name*="kg"]:not([name*="usd_rate_per_kg"])').addClass('kg');
                $form.find('[name*="usd_rate_per_kg"]').addClass('usd-rate-per-kg');
                $form.find('[name*="usd_rate_item"]:not([name*="usd_rate_item_to_inr"])').addClass('usd-rate-item');
                $form.find('[name*="usd_rate_item_to_inr"]').addClass('usd-rate-item-inr');
                $form.find('[name*="unit"]').addClass('unit-select');
                
                // Make calculated fields readonly and add styling
                $form.find('.usd-rate-item, .usd-rate-item-inr, .cs-quantity, .kg').addClass('calculated-field').prop('readonly', true);
            }

            // Add classes to initial forms
            $('.formset-form').each(function() {
                addCalculationClasses($(this));
            });

            $('#add-more-btn').click(function () {
                let formIndex = parseInt(totalForms.val());
                let lastForm = $('.formset-form:last');
                let newForm = lastForm.clone(false);

                // Fields to preserve from last form
                const fieldsToPreserve = [
                    'processing_center', 'store', 'item', 'unit','item_quality',
                    'glaze', 'freezing_category', 'brand'
                ];

                // Fields to reset completely
                const fieldsToCompletelyReset = [
                    'usd_rate_per_kg', 'usd_rate_item', 'usd_rate_item_to_inr'
                ];

                // Fields to reset normally
                const fieldsToReset = [
                    'species', 'peeling_type', 'grade', 'slab_quantity', 'c_s_quantity', 'kg'
                ];

                // Preserve values from the last form
                let preservedValues = {};
                fieldsToPreserve.forEach(function(fieldName){
                    let element = lastForm.find(`[name*="${fieldName}"]`);
                    if (element.length > 0) preservedValues[fieldName] = element.val();
                });

                // Update names, ids, reset values
                newForm.find(':input').each(function(){
                    let name = $(this).attr('name');
                    if(name){
                        let oldFieldName = name.split('-').pop();
                        name = name.replace(/-\d+-/, `-${formIndex}-`);
                        let id = 'id_'+name;
                        $(this).attr({name:name, id:id});

                        if(fieldsToPreserve.includes(oldFieldName) && preservedValues[oldFieldName] !== undefined){
                            $(this).val(preservedValues[oldFieldName]);
                        } else if(fieldsToReset.includes(oldFieldName)){
                            if($(this).is('select')) $(this).prop('selectedIndex', 0);
                            else $(this).val('');
                        } else if(fieldsToCompletelyReset.includes(oldFieldName)){
                            $(this).val('');
                        }
                    }
                });

                // Add calculation classes
                newForm.find('[name*="slab_quantity"]').addClass('slab-quantity');
                newForm.find('[name*="c_s_quantity"]').addClass('cs-quantity');
                newForm.find('[name*="kg"]:not([name*="usd_rate_per_kg"])').addClass('kg');
                newForm.find('[name*="usd_rate_per_kg"]').addClass('usd-rate-per-kg');
                newForm.find('[name*="usd_rate_item"]:not([name*="usd_rate_item_to_inr"])').addClass('usd-rate-item');
                newForm.find('[name*="usd_rate_item_to_inr"]').addClass('usd-rate-item-inr');
                newForm.find('[name*="unit"]').addClass('unit-select');
                newForm.find('[name*="item"]').addClass('item-select');
                newForm.find('[name*="species"]').addClass('species-select');
                newForm.find('[name*="peeling_type"]').addClass('peeling-select');
                newForm.find('[name*="grade"]').addClass('grade-select');

                // Reset DELETE field
                newForm.find('input[name$="-DELETE"]').prop('checked', false);

                // Update item filter for the new form based on current party selection
                updateItemFilters();

                // Fetch unit details if needed
                let unitId = preservedValues['unit'];
                if (unitId) {
                    $.getJSON("{% url 'adminapp:get_unit_details_local' %}", { unit_id: unitId }, function (data) {
                        newForm.data('precision', data.precision);
                        newForm.data('factor', data.factor);
                    });
                }

                // Append new form
                formsetContainer.append(newForm);
                totalForms.val(formIndex + 1);

                // Force clear USD fields
                setTimeout(function() {
                    newForm.find('[name*="usd_rate_per_kg"]').val('');
                    newForm.find('[name*="usd_rate_item"]:not([name*="usd_rate_item_to_inr"])').val('');
                    newForm.find('[name*="usd_rate_item_to_inr"]').val('');
                }, 100);

                // Focus first blank field
                newForm.find('[name*="species"]').focus();

                console.log('New form cloned from last form, USD fields cleared');
            });
        });
    </script>

    <!-- Remove Form Script -->
    <script>
        $(document).ready(function () {
            const formsetContainer = $("#formset-container");
            const totalForms = $("#id_form-TOTAL_FORMS");

            $(document).on("click", ".remove-btn", function () {
                if ($(".formset-form").length > 1) {
                    $(this).closest(".formset-form").remove();

                    // Re-number forms
                    let forms = $(".formset-form");
                    totalForms.val(forms.length);
                    forms.each(function (index) {
                        $(this).find("input, select, label").each(function () {
                            if ($(this).attr("name")) {
                                let name = $(this).attr("name").replace(/-\d+-/, "-" + index + "-");
                                $(this).attr("name", name);
                                $(this).attr("id", "id_" + name);
                            }
                            if ($(this).attr("for")) {
                                let newFor = $(this).attr("for").replace(/-\d+-/, "-" + index + "-");
                                $(this).attr("for", newFor);
                            }
                        });
                    });

                    // Recalculate totals
                    calculateTotals();
                } else {
                    alert("At least one form is required.");
                }
            });
        });
    </script>

    <!-- AJAX to get parties by date and party details -->
    <script>
        // Store party items globally for filtering
        let partyItems = [];

        $('#id_local_purchase_date').on('change', function () {
            const date = $(this).val();

            $('#id_party').empty().append('<option value="">---------</option>');
            $('#id_voucher_number').val('');
            partyItems = [];
            updateItemFilters();

            if (date) {
                $.get("{% url 'adminapp:get_parties_by_date' %}", { date: date }, function (data) {
                    const partySelect = $('#id_party');
                    data.parties.forEach(party => {
                        partySelect.append(`<option value="${party.id}">${party.party_name}</option>`);
                    });
                });
            }
        });
        function updateItemFilters() {
        
        }
    </script>



<!-- Load Item Qualities when Item changes - Version 6 -->
    <script>
        $(document).on("change", ".item-select:not(.quality-select)", function () {
            var itemId = $(this).val();
            var $qualitySelect = $(this).closest(".formset-form").find(".quality-select");

            if (itemId) {
                $.ajax({
                    url: "{% url 'adminapp:get_item_qualities' %}",
                    data: { "item_id": itemId },
                    dataType: "json",
                    success: function (data) {
                        $qualitySelect.empty();
                        $qualitySelect.append($("<option>", { value: "", text: "---------" }));

                        // Handle both array and object responses
                        var qualities = Array.isArray(data) ? data : data.qualities || [];

                        if (qualities.length === 0) {
                            $qualitySelect.append($("<option>", { value: "", text: "No qualities found" }));
                        } else {
                            $.each(qualities, function (index, quality) {
                                $qualitySelect.append($("<option>", {
                                    value: quality.id,
                                    text: quality.quality
                                }));
                            });
                        }

                        // Trigger change event to ensure form recognizes the new options
                        $qualitySelect.trigger('change');
                    },
                    error: function(xhr, status, error) {
                        console.log("Error loading qualities for item " + itemId);
                        console.log("Error details:", xhr.responseJSON);
                        
                        // Clear the select and add error option
                        $qualitySelect.empty();
                        $qualitySelect.append($("<option>", { value: "", text: "Error loading qualities" }));
                    }
                });
            } else {
                $qualitySelect.empty();
                $qualitySelect.append($("<option>", { value: "", text: "---------" }));
            }
        });
    </script>


    <!-- Unit calculation -->
    <script>
        $(document).ready(function () {
            let dollarRate = 0;

            // Fetch dollar rate on page load
            $.getJSON("{% url 'adminapp:get_dollar_rate_local' %}", function (data) {
                if (data.dollar_rate_to_inr) {
                    dollarRate = parseFloat(data.dollar_rate_to_inr);
                }
            });

            // Helper to recalc a single formset row
            function recalcRow($row) {
                let slabQty = parseFloat($row.find('.slab-quantity').val()) || 0;
                let usdPerKg = parseFloat($row.find('.usd-rate-per-kg').val()) || 0;
                let precision = parseFloat($row.data('precision')) || 0;
                let factor = parseFloat($row.data('factor')) || 0;

                // cs_quantity = slab / precision
                if (slabQty && precision) {
                    $row.find('.cs-quantity').val((slabQty / precision).toFixed(2));
                } else if (!slabQty) {
                    $row.find('.cs-quantity').val('');
                }

                // kg = slab  factor
                if (slabQty && factor) {
                    $row.find('.kg').val((slabQty * factor).toFixed(2));
                } else if (!slabQty) {
                    $row.find('.kg').val('');
                }

                // usd_rate_item = usd_per_kg  kg
                let kg = parseFloat($row.find('.kg').val()) || 0;
                if (kg && usdPerKg) {
                    $row.find('.usd-rate-item').val((usdPerKg * kg).toFixed(2));
                } else {
                    $row.find('.usd-rate-item').val('');
                }

                // usd_rate_item_to_inr = usd_rate_item  dollar_rate
                let usdItem = parseFloat($row.find('.usd-rate-item').val()) || 0;
                if (usdItem && dollarRate) {
                    $row.find('.usd-rate-item-inr').val((usdItem * dollarRate).toFixed(2));
                } else {
                    $row.find('.usd-rate-item-inr').val('');
                }

                // Trigger total calculation
                calculateTotals();
            }

            // When unit changes  fetch precision/factor and recalc
            $(document).on('change', '.unit-select', function () {
                let $row = $(this).closest('.formset-form');
                let unitId = $(this).val();

                if (!unitId) {
                    $row.removeData('precision').removeData('factor');
                    recalcRow($row);
                    return;
                }

                $.getJSON("{% url 'adminapp:get_unit_details_local' %}", { unit_id: unitId }, function (data) {
                    $row.data('precision', data.precision);
                    $row.data('factor', data.factor);
                    recalcRow($row);
                });
            });

            // Trigger recalculation on input changes
            $(document).on('input', '.slab-quantity, .usd-rate-per-kg', function () {
                let $row = $(this).closest('.formset-form');
                recalcRow($row);
            });

            // Ensure calculations are done before form submission
            $('#freezing-form').on('submit', function(e) {
                // Force calculation on all rows before submitting
                $('.formset-form').each(function() {
                    recalcRow($(this));
                });
                
                // Brief delay to ensure all calculations are complete
                e.preventDefault();
                setTimeout(() => {
                    // Remove readonly from calculated fields before submission so values are sent
                    $('.calculated-field').prop('readonly', false);
                    // Submit the form
                    this.submit();
                }, 100);
            });
        });
    </script>

    <!-- Function to calculate totals -->
    <script>
        function calculateTotals() {
            let totalUSD = 0, totalINR = 0, totalSlab = 0, totalCS = 0, totalKG = 0;

            $('.formset-form').each(function () {
                // Skip deleted forms
                if ($(this).find('[name$="DELETE"]').is(':checked')) {
                    return;
                }

                const getVal = (name) => {
                    const val = parseFloat($(this).find(`[name$="${name}"]`).val());
                    return isNaN(val) ? 0 : val;
                };

                const usdRate = getVal('usd_rate_item');
                const inrRate = getVal('usd_rate_item_to_inr');
                const slabQty = getVal('slab_quantity');
                const csQty = getVal('c_s_quantity');
                const kgWeight = getVal('kg');

                totalUSD += usdRate;
                totalINR += inrRate;
                totalSlab += slabQty;
                totalCS += csQty;
                totalKG += kgWeight;
            });

            $('#id_total_usd').val(totalUSD.toFixed(2));
            $('#id_total_inr').val(totalINR.toFixed(2));
            $('#id_total_slab').val(totalSlab.toFixed(2));
            $('#id_total_c_s').val(totalCS.toFixed(2));
            $('#id_total_kg').val(totalKG.toFixed(2));
        }

        $(document).on('input change', '.formset-form :input', calculateTotals);
        $(document).on('change', '.formset-form [name$="DELETE"]', calculateTotals);
        $(document).ready(calculateTotals);
    </script>

    <!-- Load Grades when Species changes -->
    <script>
        $(document).on("change", ".species-select", function () {
            var speciesId = $(this).val();
            var $gradeSelect = $(this).closest(".formset-form").find(".grade-select");

            if (speciesId) {
                $.ajax({
                    url: "{% url 'adminapp:get_grade_for_species' %}",
                    data: { "species_id": speciesId },
                    dataType: "json",
                    success: function (data) {
                        $gradeSelect.empty();
                        $gradeSelect.append($("<option>", { value: "", text: "---------" }));

                        $.each(data.grades, function (index, grade) {
                            $gradeSelect.append($("<option>", {
                                value: grade.id,
                                text: grade.grade
                            }));
                        });
                    },
                    error: function() {
                        console.log("Error loading grades for species " + speciesId);
                    }
                });
            } else {
                $gradeSelect.empty();
                $gradeSelect.append($("<option>", { value: "", text: "---------" }));
            }
        });
    </script>

        <!-- // F1 key shortcut for adding more items -->
    <script>
        $(document).ready(function() {
        $(document).on('keydown', function(e) {
            // Check if F1 key is pressed (keyCode 112)
            if (e.keyCode === 112 || e.which === 112) {
                e.preventDefault(); // Prevent browser's default F1 help
                $('#add-more-btn').click(); // Trigger the add more button
                return false;
            }
        });
    });
    </script>

    <!-- // Delete key shortcut for removing the focused item -->
    <script>
    $(document).ready(function () {
        const formsetContainer = $("#formset-container");
        const totalForms = $("#id_form-TOTAL_FORMS");

        // Remove (event delegation so it works for new forms too)
        function removeForm(form) {
            if ($(".formset-form").length > 1) {
                form.remove();

                // Re-number forms
                let forms = $(".formset-form");
                totalForms.val(forms.length);
                forms.each(function (index) {
                    $(this).find("input, select, label").each(function () {
                        if ($(this).attr("name")) {
                            let name = $(this).attr("name").replace(/-\d+-/, "-" + index + "-");
                            $(this).attr("name", name);
                            $(this).attr("id", "id_" + name);
                        }
                        if ($(this).attr("for")) {
                            let newFor = $(this).attr("for").replace(/-\d+-/, "-" + index + "-");
                            $(this).attr("for", newFor);
                        }
                    });
                });
            } else {
                alert("At least one form is required.");
            }
        }

        // Click delete button
        $(document).on("click", ".remove-btn", function () {
            removeForm($(this).closest(".formset-form"));
        });

        // Keyboard Delete key
        $(document).on("keydown", function (e) {
            if (e.key === "Delete") {
                let activeElement = $(document.activeElement).closest(".formset-form");
                if (activeElement.length) {
                    e.preventDefault();
                    removeForm(activeElement);
                }
            }
        });
    });
    </script>

    <!-- // Arrow key navigation for form fields -->
    <script>
        $(document).ready(function() {
            // Get all focusable form elements
            function getFocusableElements() {
                return $('input:not([type="hidden"]), select, textarea').filter(':visible');
            }

            $(document).on('keydown', 'input, select, textarea', function(e) {
                // Check if left arrow key is pressed (keyCode 37)
                if (e.keyCode === 37 || e.which === 37) {
                    // Only trigger if cursor is at the beginning of input or it's a select
                    if ($(this).is('select') || 
                        ($(this).is('input') && this.selectionStart === 0)) {
                        
                        e.preventDefault();
                        let focusableElements = getFocusableElements();
                        let currentIndex = focusableElements.index(this);
                        
                        // Move to previous field (left arrow = previous)
                        if (currentIndex > 0) {
                            focusableElements.eq(currentIndex - 1).focus();
                        }
                        return false;
                    }
                }
                
                // Check if right arrow key is pressed (keyCode 39)  
                if (e.keyCode === 39 || e.which === 39) {
                    // Only trigger if cursor is at the end of input or it's a select
                    if ($(this).is('select') || 
                        ($(this).is('input') && this.selectionStart === this.value.length)) {
                        
                        e.preventDefault();
                        let focusableElements = getFocusableElements();
                        let currentIndex = focusableElements.index(this);
                        
                        // Move to next field (right arrow = next)
                        if (currentIndex < focusableElements.length - 1) {
                            focusableElements.eq(currentIndex + 1).focus();
                        }
                        return false;
                    }
                }
            });
        });
    </script>
</body>

</html>